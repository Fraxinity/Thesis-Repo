<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VacanSee: Campus Event Space Reservation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        #login-page { display: flex; align-items: center; justify-content: center; height: 100vh; background-color: #e2e8f0; }
        .login-card { background: white; padding: 3rem; border-radius: 1.5rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); width: 100%; max-width: 420px; }
        .app-container { display: grid; grid-template-columns: 280px 1fr; height: 100vh; }
        .sidebar { background-color: #ffffff; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; padding: 1.5rem; }
        .main-wrapper { display: flex; flex-direction: column; overflow-y: auto; }
        header { padding: 1.5rem 2.5rem; border-bottom: 1px solid #e2e8f0; background-color: #ffffff; position: sticky; top: 0; z-index: 10; }
        .main-content { padding: 2.5rem; flex-grow: 1; }
        .nav-button { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.5rem; color: #475569; font-weight: 500; transition: all 0.2s; }
        .nav-button:hover { background-color: #f1f5f9; color: #0ea5e9; }
        .nav-button.active { background-color: #e0f2fe; color: #0ea5e9; font-weight: 600; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 2rem; border-radius: 1rem; max-width: 800px; width: 90%; transform: scale(0.95); transition: transform 0.3s; max-height: 90vh; overflow-y: auto; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
    </style>
</head>
<body>

    <div id="login-page">
        <div class="login-card">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-bold text-slate-800">Vacan<span class="text-sky-500">See</span></h1>
                <p class="text-slate-500 mt-2">Sign in to book event spaces</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-slate-700 mb-1">Username</label>
                    <input type="text" id="username" value="admin" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <input type="password" id="password" value="admin123" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                </div>
                <button type="submit" class="w-full bg-sky-500 text-white py-3 rounded-lg font-semibold hover:bg-sky-600 transition">Sign In</button>
                <p id="login-error" class="text-red-500 text-sm text-center mt-4"></p>
            </form>
        </div>
    </div>

    <div id="app-container" class="app-container hidden">
        <aside class="sidebar">
            <div class="text-sky-500 mb-10">
                <h1 class="text-3xl font-bold">Vacan<span class="text-sky-400">See</span></h1>
            </div>
            <nav class="flex flex-col gap-4 flex-grow w-full">
                <div>
                    <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 px-3">Main</h2>
                    <button data-view="dashboard" class="nav-button active w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                        <span>Dashboard</span>
                    </button>
                </div>
                <div>
                    <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 px-3">Views</h2>
                    <button data-view="facilities" class="nav-button w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 6v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6M20 6v14a2 2 0 0 1-2 2h-6a2 2 0 0 1-2-2V6"/><rect x="4" y="2" width="16" height="4" rx="2"/></svg>
                        <span>Facilities Catalog</span>
                    </button>
                </div>
                <div id="admin-nav-section" style="display: none;">
                    <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 px-3">Admin</h2>
                    <button data-view="reservations" class="nav-button w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm12 5H5v5h10V10zm-9-3a1 1 0 000 2h4a1 1 0 000-2H6z" clip-rule="evenodd" /></svg>
                        <span>Requests</span>
                    </button>
                </div>
            </nav>
            <div class="mt-auto border-t border-slate-200 pt-4">
                <div class="flex items-center gap-3">
                    <img id="sidebar-avatar" src="" alt="User" class="w-10 h-10 rounded-full">
                    <div>
                        <p id="sidebar-username" class="font-semibold text-slate-700"></p>
                        <button id="logout-btn" class="text-xs text-slate-500 hover:text-sky-500">Log out</button>
                    </div>
                </div>
            </div>
        </aside>

        <div class="main-wrapper no-scrollbar">
            <header>
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-slate-800">VacanSee</h2>
                    <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Database Connected</span>
                </div>
            </header>
            <main class="main-content">
                <div id="dashboard-view" data-view="dashboard">
                    <h2 class="text-2xl font-bold text-slate-800 mb-2" id="dashboard-title">Welcome</h2>
                    <p class="text-slate-500 mb-8" id="current-datetime">Loading...</p>
                    <div class="bg-white p-8 rounded-xl border border-slate-200">
                        <h3 class="text-2xl font-bold text-slate-800 mb-4">Available Facilities</h3>
                        <div id="facilities-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="text-center py-8 text-slate-500">Loading facilities...</div>
                        </div>
                    </div>
                </div>

                <div id="facilities-view" data-view="facilities" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Facilities Catalog</h2>
                    <div id="facilities-catalog" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <div class="text-center py-8 text-slate-500">Loading facilities...</div>
                    </div>
                </div>

                <div id="reservations-view" data-view="reservations" class="hidden">
                    <h2 class="text-3xl font-bold text-slate-800 mb-6">Admin: Reservation Requests</h2>
                    <div id="reservations-list" class="space-y-4">
                        <p class="text-slate-500">Loading reservations...</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="notification-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <p id="notification-message" class="text-lg mb-6"></p>
            <button id="notification-ok" class="px-6 py-2 bg-sky-500 text-white rounded-lg hover:bg-sky-600">OK</button>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('VacanSee initialized - Backend Connected');
        
        // Get rooms from Flask backend
        var roomsFromBackend = {{ rooms|tojson|safe }};
        console.log('Loaded rooms:', roomsFromBackend);
        
        var currentUser = null;
        var allReservations = [];
        
        // UI Elements
        var loginPage = document.getElementById('login-page');
        var appContainer = document.getElementById('app-container');
        var loginForm = document.getElementById('login-form');
        var loginError = document.getElementById('login-error');
        var logoutBtn = document.getElementById('logout-btn');
        var sidebarAvatar = document.getElementById('sidebar-avatar');
        var sidebarUsername = document.getElementById('sidebar-username');
        var dashboardTitle = document.getElementById('dashboard-title');
        var currentDatetimeEl = document.getElementById('current-datetime');
        var notificationModal = document.getElementById('notification-modal');
        var notificationOkBtn = document.getElementById('notification-ok');
        var facilitiesList = document.getElementById('facilities-list');
        var facilitiesCatalog = document.getElementById('facilities-catalog');
        var reservationsList = document.getElementById('reservations-list');
        var navButtons = document.querySelectorAll('.nav-button');
        var adminNavSection = document.getElementById('admin-nav-section');
        
        function showModal(modal) { modal.classList.add('visible'); }
        function hideModal(modal) { modal.classList.remove('visible'); }
        function showNotification(message) { 
            document.getElementById('notification-message').textContent = message; 
            showModal(notificationModal); 
        }
        
        function updateDateTime() {
            var now = new Date();
            currentDatetimeEl.textContent = now.toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
        }
        
        async function loadReservations() {
            try {
                var response = await fetch('/api/reservations');
                if (response.ok) {
                    allReservations = await response.json();
                    console.log('Loaded reservations:', allReservations);
                    renderReservations();
                }
            } catch (error) {
                console.error('Error loading reservations:', error);
            }
        }
        
        function renderFacilities() {
            facilitiesList.innerHTML = '';
            facilitiesCatalog.innerHTML = '';
            
            if (!roomsFromBackend || roomsFromBackend.length === 0) {
                facilitiesList.innerHTML = '<div class="col-span-3 text-center py-8 text-red-500">No facilities found. Run /setup first.</div>';
                facilitiesCatalog.innerHTML = '<div class="col-span-3 text-center py-8 text-red-500">No facilities found. Run /setup first.</div>';
                return;
            }
            
            roomsFromBackend.forEach(function(room) {
                // Dashboard cards
                var dashCard = document.createElement('div');
                dashCard.className = 'bg-slate-50 p-4 rounded-lg border border-slate-200 hover:border-sky-300 transition cursor-pointer';
                dashCard.innerHTML = '<div class="flex justify-between items-start mb-2">' +
                    '<h4 class="font-bold text-slate-800">' + room.name + '</h4>' +
                    '<span class="text-xs bg-sky-100 text-sky-800 px-2 py-1 rounded-full">' + room.capacity + '</span>' +
                    '</div>' +
                    '<p class="text-sm text-slate-600 mb-2">' + (room.description || 'No description') + '</p>' +
                    '<p class="text-xs text-slate-500">' + (room.usual_activity || 'General use') + '</p>';
                facilitiesList.appendChild(dashCard);
                
                // Catalog cards
                var imageUrl = 'https://placehold.co/400x200/f0f9ff/0ea5e9?text=' + encodeURIComponent(room.name.replace(/\s/g, '+'));
                var catCard = document.createElement('div');
                catCard.className = 'bg-white rounded-xl shadow-lg overflow-hidden border border-slate-100 flex flex-col transition hover:shadow-xl hover:border-sky-300';
                catCard.innerHTML = '<img src="' + imageUrl + '" alt="' + room.name + '" class="w-full h-40 object-cover">' +
                    '<div class="p-5 flex flex-col flex-grow">' +
                    '<h3 class="text-xl font-bold text-slate-800 mb-2">' + room.name + '</h3>' +
                    '<p class="text-sm text-slate-600 mb-3 flex-grow">' + (room.description || '') + '</p>' +
                    '<div class="space-y-1 text-sm mb-4 pt-3 border-t">' +
                    '<p><span class="font-semibold text-sky-600">Capacity:</span> ' + room.capacity + '</p>' +
                    '<p><span class="font-semibold text-sky-600">Usual Activity:</span> ' + (room.usual_activity || 'General') + '</p>' +
                    '</div>' +
                    '<button class="w-full bg-sky-500 text-white py-2 rounded-lg hover:bg-sky-600 transition">Reserve</button>' +
                    '</div>';
                facilitiesCatalog.appendChild(catCard);
            });
        }
        
        function renderReservations() {
            reservationsList.innerHTML = '';
            
            if (!allReservations || allReservations.length === 0) {
                reservationsList.innerHTML = '<p class="text-slate-500">No reservations found.</p>';
                return;
            }
            
            allReservations.forEach(function(res) {
                var statusColor = 'bg-yellow-100 text-yellow-800';
                if (res.status === 'approved') statusColor = 'bg-green-100 text-green-800';
                else if (res.status === 'denied') statusColor = 'bg-red-100 text-red-800';
                else if (res.status === 'concept-approved') statusColor = 'bg-blue-100 text-blue-800';
                
                var card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl border border-slate-200 hover:shadow-md transition';
                card.innerHTML = '<div class="flex justify-between items-start">' +
                    '<div>' +
                    '<h4 class="font-bold text-slate-800">' + res.activity_purpose + '</h4>' +
                    '<p class="text-sm text-slate-600">By: ' + res.user + ' (' + res.department + ')</p>' +
                    '<p class="text-xs text-slate-500">Filed: ' + (res.date_filed || 'N/A') + '</p>' +
                    '</div>' +
                    '<span class="text-xs font-medium px-3 py-1 rounded-full ' + statusColor + '">' + res.status + '</span>' +
                    '</div>';
                reservationsList.appendChild(card);
            });
        }
        
        function setupUI() {
            var avatarUrl = currentUser.role === 'admin' 
                ? 'https://placehold.co/100x100/0ea5e9/ffffff?text=A' 
                : 'https://placehold.co/100x100/64748b/ffffff?text=U';
            
            sidebarAvatar.src = avatarUrl;
            sidebarUsername.textContent = currentUser.username;
            dashboardTitle.textContent = 'Welcome, ' + currentUser.username;
            
            adminNavSection.style.display = currentUser.role === 'admin' ? 'block' : 'none';
            
            updateDateTime();
            renderFacilities();
            
            if (currentUser.role === 'admin') {
                loadReservations();
            }
        }
        
        function switchView(viewName) {
            navButtons.forEach(function(btn) {
                btn.classList.toggle('active', btn.dataset.view === viewName);
            });
            var contentViews = document.querySelectorAll('.main-content > [data-view]');
            contentViews.forEach(function(view) {
                if (view.dataset.view === viewName) {
                    view.classList.remove('hidden');
                } else {
                    view.classList.add('hidden');
                }
            });
        }
        
        // Login handler
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            loginError.textContent = '';
            
            var username = document.getElementById('username').value;
            var password = document.getElementById('password').value;
            
            fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password: password })
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.status === 'success') {
                    currentUser = { 
                        username: data.username, 
                        role: data.role,
                        department: data.department
                    };
                    loginPage.style.display = 'none';
                    appContainer.classList.remove('hidden');
                    setupUI();
                    showNotification('Welcome, ' + username + '!');
                } else {
                    loginError.textContent = data.message || 'Invalid credentials';
                }
            })
            .catch(function(error) {
                console.error('Login error:', error);
                loginError.textContent = 'Connection error';
            });
        });
        
        // Logout handler
        logoutBtn.addEventListener('click', function() {
            fetch('/logout')
            .then(function() {
                currentUser = null;
                loginPage.style.display = 'flex';
                appContainer.classList.add('hidden');
                loginForm.reset();
            });
        });
        
        // Navigation
        navButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                var view = button.dataset.view;
                if (view === 'reservations' && currentUser.role !== 'admin') return;
                switchView(view);
            });
        });
        
        // Notification
        notificationOkBtn.addEventListener('click', function() { 
            hideModal(notificationModal); 
        });
    });
</script>

</body>
</html>